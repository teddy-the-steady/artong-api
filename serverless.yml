service: artong-api
app: artong-api

provider:
  name: aws
  runtime: nodejs12.x
  stage: stage #prod
  region: ap-northeast-2
  environment:
    NODE_PATH: "./:/opt/node_modules"

package:
 exclude:
   - node_layers/**

layers:
  NodeModules:
    path: node_layers
    description: "includes pq, handlebars, joi"

plugins:
  - serverless-iam-roles-per-function

custom:
  DB_CONFIG: ${file(./config.js):DB_CONFIG}

functions:
  hello:
    handler: handler.hello
    events:
     - http: GET users/hello
  artong:
    handler: artong/handler/test.handler
    events:
     - http:
        path: test/product
        method: get
        cors: true
        # authorizer: arn:aws:lambda:ap-northeast-2:821343553435:function:authorizer
     - http:
        path: test/product/{id}
        method: get
        cors: true
        # authorizer: arn:aws:lambda:ap-northeast-2:821343553435:function:authorizer
     - http:
        path: test/product
        method: post
        cors: true
        # authorizer: arn:aws:lambda:ap-northeast-2:821343553435:function:authorizer
    layers:
     - {Ref: NodeModulesLambdaLayer} 
    environment:
      DB_HOST: ${self:custom.DB_CONFIG.${self:provider.stage}.DB_HOST}
      DB_DATABASE: ${self:custom.DB_CONFIG.${self:provider.stage}.DB_DATABASE}
      DB_USER: ${self:custom.DB_CONFIG.${self:provider.stage}.DB_USER}
      DB_PASSWORD: ${self:custom.DB_CONFIG.${self:provider.stage}.DB_PASSWORD}

resources:
  Resources:
    GatewayResponseDefault4XX:
      Type: 'AWS::ApiGateway::GatewayResponse'
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
        ResponseType: DEFAULT_4XX
        RestApiId:
          Ref: 'ApiGatewayRestApi'
    GatewayResponseDefault5XX:
      Type: 'AWS::ApiGateway::GatewayResponse'
      Properties:
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
        ResponseType: DEFAULT_5XX
        RestApiId:
          Ref: 'ApiGatewayRestApi'